<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lamp Simulations</title>
    <script src="https://cdn.jsdelivr.net/npm/konva@9/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
      body {
        background: #f0f0f0;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      #container {
        background: #dcdcdc;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script>
      const stage = new Konva.Stage({
        container: "container",
        width: 900,
        height: 600,
      });

      const layer = new Konva.Layer();
      stage.add(layer);

      const assets = {
        lightOff: "light_off.png",
        lightOn: "light_on.png",
        airplane: "airplane.png",
        battery: "battery.png",
        book: "book.png",
        slot: "slot.png",
      };

      loadImages(assets, initSimulation);

      function loadImages(source, callback) {
        const images = {};
        let loaded = 0;
        const numImages = Object.keys(source).length;

        for (let key in source) {
          images[key] = new Image();
          images[key].onload = () => {
            if (++loaded >= numImages) {
              callback(images);
            }
          };
          images[key].src = source[key];
        }
      }

      function initSimulation(images) {
        const slot = new Konva.Image({
          image: images.slot,
          x: 100,
          y: 120,
          width: 100,
          height: 100,
        });
        layer.add(slot);

        const lamp = new Konva.Image({
          image: images.lightOff,
          x: 650,
          y: 100,
          width: 120,
          height: 120,
          shadowBlur: 0,
        });
        layer.add(lamp);

        const cablePositive = new Konva.Line({
          points: [
            slot.x() + 50,
            slot.y() + 10,
            (slot.x() + lamp.x()) / 2,
            slot.y() - 60,
            lamp.x() + 60,
            lamp.y(),
          ],
          stroke: "red",
          strokeWidth: 6,
          lineCap: "round",
          lineJoin: "round",
          tension: 0.5,
          shadowBlur: 0,
        });

        const cableNegative = new Konva.Line({
          points: [
            slot.x() + 50,
            slot.y() + slot.height() - 10,
            (slot.x() + lamp.x()) / 2,
            slot.y() + 150,
            lamp.x() + 60,
            lamp.y() + lamp.height(),
          ],
          stroke: "black",
          strokeWidth: 6,
          lineCap: "round",
          lineJoin: "round",
          tension: 0.5,
          shadowBlur: 0,
        });

        function activateCable(active = false) {
          const glow = active ? 2 : 0;
          gsap.to(cablePositive, {
            shadowBlur: glow,
            shadowColor: "red",
            duration: 0.3,
          });
          gsap.to(cableNegative, {
            shadowBlur: glow,
            shadowColor: "black",
            duration: 0.3,
          });
        }

        layer.add(cablePositive);
        layer.add(cableNegative);
        layer.draw();

        const items = [
          { name: "book", image: images.book, x: 100 },
          { name: "battery", image: images.battery, x: 375 },
          { name: "airplane", image: images.airplane, x: 650 },
        ];

        const itemsNodes = {};
        items.forEach((item) => {
          const node = new Konva.Image({
            image: item.image,
            x: item.x,
            y: 400,
            width: 120,
            height: 120,
            draggable: true,
            name: item.name,
          });

          node.startX = item.x;
          node.startY = 400;

          layer.add(node);
          itemsNodes[item.name] = node;
        });
        layer.draw();

        let currentItemInSlot = null;

        stage.on("dragend", (e) => {
          const item = e.target;
          const slotBox = slot.getClientRect();
          const itemBox = item.getClientRect();
          const intersects = checkIntersect(slotBox, itemBox);

          if (intersects) {
            if (currentItemInSlot && currentItemInSlot !== item) {
              gsap.to(currentItemInSlot, {
                x: currentItemInSlot.startX,
                y: currentItemInSlot.startY,
                duration: 0.4,
                ease: "power2.inOut",
              });
              currentItemInSlot = null;
            }

            const slotCenterX = slot.x() + slot.width() / 2 - item.width() / 2;
            const slotCentery =
              slot.y() + slot.height() / 2 - item.height() / 2;

            gsap.to(item, {
              x: slotCenterX,
              y: slotCentery,
              scaleX: 1,
              scaleY: 1,
              duration: 0.3,
              ease: "power2.out",
            });

            currentItemInSlot = item;

            if (item.name() === "battery") {
              turnOnLamp(lamp, images);
              activateCable(true);
            } else {
              turnOffLamp(lamp, images);
              activateCable(false);
            }
          } else {
            gsap.to(item, {
              x: item.startX,
              y: item.startY,
              scaleX: 1,
              scaleY: 1,
              duration: 0.4,
              ease: "back.out(1.7)",
            });
            turnOffLamp(lamp, images);
            activateCable(false);

            if (currentItemInSlot === item) {
              currentItemInSlot = null;
            }
          }

          slot.opacity(1);
          layer.batchDraw();
        });

        stage.on("dragstart", (e) => {
          const item = e.target;
          item.moveToTop();
          gsap.to(item, { scaleX: 1.1, scaleY: 1.1, duration: 0.2 });
        });
      }

      function checkIntersect(a, b) {
        return !(
          a.x > b.x + b.width ||
          a.x + a.width < b.x ||
          a.y > b.y + b.height ||
          a.y + a.height < b.y
        );
      }

      function turnOnLamp(lamp, images) {
        lamp.image(images.lightOn);
        const tl = gsap.timeline();

        tl.to(lamp, { opacity: 0.3, duration: 0.1 })
          .to(lamp, { opacity: 1, duration: 0.1 })
          .to(lamp, { opacity: 0.1, duration: 1.2 })
          .to(lamp, { opacity: 1, duration: 0.12 })
          .to(lamp, { opacity: 0.3, duration: 0.05 })
          .to(lamp, { opacity: 1, duration: 0.05 });

        gsap.to(lamp, { duration: 0.3 });
      }

      function turnOffLamp(lamp, images) {
        lamp.image(images.lightOff);
        const tl = gsap.timeline();
        tl.to(lamp, { opacity: 0.3, duration: 0.1 })
          .to(lamp, { opacity: 1, duration: 0.1 })
          .to(lamp, { opacity: 0.6, duration: 0.08 })
          .to(lamp, { opacity: 1, duration: 0.12 })
          .to(lamp, { opacity: 0.9, duration: 0.05 })
          .to(lamp, { opacity: 1, duration: 0.05 });
        gsap.to(lamp, { duration: 0.3 });
      }
    </script>
  </body>
</html>
